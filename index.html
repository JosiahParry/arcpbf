<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Process ArcGIS Protocol Buffer FeatureCollections • arcpbf</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Process ArcGIS Protocol Buffer FeatureCollections">
<meta property="og:description" content="The ArcGIS Protocol Buffer FeatureCollection specification encodes 
  geographic and attribute data using Google's protocol buffer (pbf) specification. 
  Modern ArcGIS REST endpoints can return pbfs which are smaller and faster to 
  consume. arcpbf processes FeatureCollection pbfs and returns the results as R
  objects including data.frames and simple feature collections. ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">arcpbf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">


<div class="section level1">
<div class="page-header"><h1 id="arcpbf">arcpbf<a class="anchor" aria-label="anchor" href="#arcpbf"></a>
</h1></div>
<p><code>{arcpbf}</code> is an R package that processes Esri Protocol Buffers. It is written in Rust and powered by the <a href="https://github.com/extendr/extendr" class="external-link">extendr</a> library.</p>
<p>arcpbf has functions for reading protocol buffer (pbf) results from an ArcGIS REST API result. pbf results are returned when <code>f=pbf</code> in a <a href="https://developers.arcgis.com/rest/services-reference/enterprise/query-feature-service-layer-.htm" class="external-link">query</a>. The package is intended to be extremely lightweight and fast. As such, it has no hard dependencies.</p>
<blockquote>
<p><strong><em>Important</em></strong>: Rust must be installed to compile the package. Run the one line installation instructions at <a href="https://rustup.rs/" class="external-link uri">https://rustup.rs/</a>. To verify your Rust installation is compatible, run <code>rextendr::rust_sitrep()</code>. That’s it.</p>
</blockquote>
<div class="section level2">
<h2 id="tldr">TL;DR<a class="anchor" aria-label="anchor" href="#tldr"></a>
</h2>
<ul>
<li>
<code><a href="reference/open_pbf.html">open_pbf()</a></code> will read a FeatureCollection <code>pbf</code> file into a raw vector</li>
<li>
<code><a href="reference/read_pbf.html">read_pbf()</a></code> will read a FeatureCollection <code>pbf</code> file <em>and</em> process it</li>
<li>
<code><a href="reference/process_pbf.html">process_pbf()</a></code> will process a raw vector or a list of raw vectors</li>
<li>
<code><a href="reference/post_process_pbf.html">post_process_pbf()</a></code> will apply post processing steps to the results of <code><a href="reference/process_pbf.html">process_pbf()</a></code>
<ul>
<li>set <code>use_sf = FALSE</code> to return a <code>data.frame</code> otherwise an <code>sf</code> object will be returned</li>
</ul>
</li>
<li>
<code><a href="reference/httr2.html">resp_body_pbf()</a></code> process an <code>httr2_response</code> as a pbf</li>
<li>
<code>multi_resp_process()</code> processes a list of <code>httr2_response</code> using <code><a href="reference/process_pbf.html">process_pbf()</a></code>
<ul>
<li>if an element is not a response or have a 200 status code, <code>NULL</code> is returned</li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="basic-usage">Basic usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h2>
<p>There are two ways of processing a FeatureCollection pbf. We either can read directly from a binary file (typically with a <code>.pbf</code> extension). Or, we process the a raw vector containing the binary of a pbf as returned by an http request. These are accomplished with <code><a href="reference/read_pbf.html">read_pbf()</a></code> and <code><a href="reference/process_pbf.html">process_pbf()</a></code> respectively.</p>
<p>Here we read a single pbf file.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">arcpbf</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_pbf.html">read_pbf</a></span><span class="op">(</span><span class="st">"inst/pbfs/pnts.pbf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ attributes:'data.frame':  10 obs. of  18 variables:</span></span>
<span><span class="co">#&gt;  $ geometry  :List of 10</span></span>
<span><span class="co">#&gt;   ..- attr(*, "class")= chr [1:2] "sfc_POINT" "sfc"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "precision")= num 0</span></span>
<span><span class="co">#&gt;   ..- attr(*, "n_empty")= int 0</span></span>
<span><span class="co">#&gt;   ..- attr(*, "bbox")= Named num [1:4] NA NA NA NA</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "names")= chr [1:4] "xmin" "ymin" "xmax" "ymax"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "crs")=List of 2</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "class")= chr "crs"</span></span>
<span><span class="co">#&gt;  $ sr        :List of 5</span></span></code></pre></div>
<p>For pbf files containing geometries, we retrieve a list of 3 elements:</p>
<ul>
<li>
<code>attributes</code> is a <code>data.frame</code> of the fields of the FeatureCollection</li>
<li>
<code>geometry</code> is a pseudo-sfc object (more on this later) which is a list of sfg geometry objects</li>
<li>
<code>sr</code> is a named list of the spatial reference of the feature collection</li>
</ul>
<p>Whereas FeatureCollections <em>without geometries</em> will always return a single data.frame.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/read_pbf.html">read_pbf</a></span><span class="op">(</span><span class="st">"inst/pbfs/small-table.pbf"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   OBJECTID       Adoption_Service_Provider  DBA       city                state</span></span>
<span><span class="co">#&gt; 1        1 A Family in Bloom Adoption, LLC &lt;NA&gt;    Boulder             Colorado</span></span>
<span><span class="co">#&gt; 2        2     A Love Beyond Borders, Inc. &lt;NA&gt;     Denver             Colorado</span></span>
<span><span class="co">#&gt; 3        3                  Adopolis, Inc. &lt;NA&gt; Washington District of Columbia</span></span>
<span><span class="co">#&gt;    Accreditation_or_Approval_Statu Accredited_Approvedto_Provide</span></span>
<span><span class="co">#&gt; 1 Accredited/Approved – In Process         Incoming and Outgoing</span></span>
<span><span class="co">#&gt; 2                         Approved                      Incoming</span></span>
<span><span class="co">#&gt; 3                       Accredited                      Incoming</span></span>
<span><span class="co">#&gt;                                           full_address</span></span>
<span><span class="co">#&gt; 1           Adoption Service Provider,Boulder,Colorado</span></span>
<span><span class="co">#&gt; 2      A Family in Bloom Adoption, LLC,Denver,Colorado</span></span>
<span><span class="co">#&gt; 3 A Love Beyond Borders, Inc.,Washington,Washington DC</span></span></code></pre></div>
<p>These results use no external dependencies. If we want to convert the named list into a familiar sf object we will have to <strong>post-process</strong> it using <code><a href="reference/post_process_pbf.html">post_process_pbf()</a></code>. The <code>use_sf</code> argument, which defaults to <code>TRUE</code>, will use the <code>sf</code> package to return an <code>sf</code> object.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/post_process_pbf.html">post_process_pbf</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 10 features and 18 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: NA ymin: NA xmax: NA ymax: NA</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / Pseudo-Mercator</span></span>
<span><span class="co">#&gt;           id          retailer                fascia</span></span>
<span><span class="co">#&gt; 1 1010001841 Marks and Spencer Marks and Spencer MSA</span></span>
<span><span class="co">#&gt; 2 1010000921              Asda      Asda Supercentre</span></span>
<span><span class="co">#&gt; 3 1010003178        Sainsburys            Sainsburys</span></span>
<span><span class="co">#&gt; 4 1010014115           Budgens               Budgens</span></span>
<span><span class="co">#&gt; 5 1010015258              Lidl                  Lidl</span></span>
<span><span class="co">#&gt;                      store_name                  add_one          add_two</span></span>
<span><span class="co">#&gt; 1   M&amp;S Reading East M4 Moto SF Reading East Services M4             &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2 Asda Lower Earley Supercentre             Chalfort Way     Lower Earley</span></span>
<span><span class="co">#&gt; 3             Sainsburys Calcot                Bath Road           Calcot</span></span>
<span><span class="co">#&gt; 4      Budgens Three Mile Cross         Basingstoke Road Three Mile Cross</span></span>
<span><span class="co">#&gt; 5           Lidl Calcot Reading                Bath Road             &lt;NA&gt;</span></span>
<span><span class="co">#&gt;               town suburb postcode   long_wgs  lat_wgs    bng_e    bng_n</span></span>
<span><span class="co">#&gt; 1          Reading Calcot RG30 3UQ -1.0350837 51.42616 467183.5 170124.7</span></span>
<span><span class="co">#&gt; 2          Reading Earley  RG6 5TT -0.9327606 51.42482 474299.7 170075.0</span></span>
<span><span class="co">#&gt; 3          Reading Calcot RG31 7SA -1.0614843 51.44304 465324.0 171978.0</span></span>
<span><span class="co">#&gt; 4 Three Mile Cross   &lt;NA&gt;  RG7 1BA -0.9739431 51.40521 471466.9 167853.1</span></span>
<span><span class="co">#&gt; 5          Reading Calcot RG30 2HB -1.0244860 51.44386 467894.1 172102.9</span></span>
<span><span class="co">#&gt;                            pqi open_date                              size_band</span></span>
<span><span class="co">#&gt; 1 Rooftop geocoded by Geolytix      &lt;NA&gt;                    &lt; 3,013 ft2 (280m2)</span></span>
<span><span class="co">#&gt; 2 Rooftop geocoded by Geolytix      &lt;NA&gt;                30,138 ft2 &gt; (2,800 m2)</span></span>
<span><span class="co">#&gt; 3 Rooftop geocoded by Geolytix      &lt;NA&gt;                30,138 ft2 &gt; (2,800 m2)</span></span>
<span><span class="co">#&gt; 4 Rooftop geocoded by Geolytix  20169999    3,013 &lt; 15,069 ft2 (280 &lt; 1,400 m2)</span></span>
<span><span class="co">#&gt; 5 Rooftop geocoded by Geolytix  20171026 15,069 &lt; 30,138 ft2 (1,400 &lt; 2,800 m2)</span></span>
<span><span class="co">#&gt;      county ObjectId                  geometry</span></span>
<span><span class="co">#&gt; 1 Berkshire        1   POINT (-115225 6697025)</span></span>
<span><span class="co">#&gt; 2 Berkshire        2 POINT (-103834.4 6696787)</span></span>
<span><span class="co">#&gt; 3 Berkshire        3 POINT (-118163.9 6700039)</span></span>
<span><span class="co">#&gt; 4 Berkshire        4 POINT (-108418.9 6693287)</span></span>
<span><span class="co">#&gt; 5 Berkshire        5 POINT (-114045.3 6700186)</span></span>
<span><span class="co">#&gt;  [ reached 'max' / getOption("max.print") -- omitted 5 rows ]</span></span></code></pre></div>
<p>If it is set to <code>FALSE</code>, it will return a <code>data.frame</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/post_process_pbf.html">post_process_pbf</a></span><span class="op">(</span><span class="va">x</span>, use_sf <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;           id          retailer                fascia</span></span>
<span><span class="co">#&gt; 1 1010001841 Marks and Spencer Marks and Spencer MSA</span></span>
<span><span class="co">#&gt; 2 1010000921              Asda      Asda Supercentre</span></span>
<span><span class="co">#&gt; 3 1010003178        Sainsburys            Sainsburys</span></span>
<span><span class="co">#&gt; 4 1010014115           Budgens               Budgens</span></span>
<span><span class="co">#&gt; 5 1010015258              Lidl                  Lidl</span></span>
<span><span class="co">#&gt;                      store_name                  add_one          add_two</span></span>
<span><span class="co">#&gt; 1   M&amp;S Reading East M4 Moto SF Reading East Services M4             &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2 Asda Lower Earley Supercentre             Chalfort Way     Lower Earley</span></span>
<span><span class="co">#&gt; 3             Sainsburys Calcot                Bath Road           Calcot</span></span>
<span><span class="co">#&gt; 4      Budgens Three Mile Cross         Basingstoke Road Three Mile Cross</span></span>
<span><span class="co">#&gt; 5           Lidl Calcot Reading                Bath Road             &lt;NA&gt;</span></span>
<span><span class="co">#&gt;               town suburb postcode   long_wgs  lat_wgs    bng_e    bng_n</span></span>
<span><span class="co">#&gt; 1          Reading Calcot RG30 3UQ -1.0350837 51.42616 467183.5 170124.7</span></span>
<span><span class="co">#&gt; 2          Reading Earley  RG6 5TT -0.9327606 51.42482 474299.7 170075.0</span></span>
<span><span class="co">#&gt; 3          Reading Calcot RG31 7SA -1.0614843 51.44304 465324.0 171978.0</span></span>
<span><span class="co">#&gt; 4 Three Mile Cross   &lt;NA&gt;  RG7 1BA -0.9739431 51.40521 471466.9 167853.1</span></span>
<span><span class="co">#&gt; 5          Reading Calcot RG30 2HB -1.0244860 51.44386 467894.1 172102.9</span></span>
<span><span class="co">#&gt;                            pqi open_date                              size_band</span></span>
<span><span class="co">#&gt; 1 Rooftop geocoded by Geolytix      &lt;NA&gt;                    &lt; 3,013 ft2 (280m2)</span></span>
<span><span class="co">#&gt; 2 Rooftop geocoded by Geolytix      &lt;NA&gt;                30,138 ft2 &gt; (2,800 m2)</span></span>
<span><span class="co">#&gt; 3 Rooftop geocoded by Geolytix      &lt;NA&gt;                30,138 ft2 &gt; (2,800 m2)</span></span>
<span><span class="co">#&gt; 4 Rooftop geocoded by Geolytix  20169999    3,013 &lt; 15,069 ft2 (280 &lt; 1,400 m2)</span></span>
<span><span class="co">#&gt; 5 Rooftop geocoded by Geolytix  20171026 15,069 &lt; 30,138 ft2 (1,400 &lt; 2,800 m2)</span></span>
<span><span class="co">#&gt;      county ObjectId                  geometry</span></span>
<span><span class="co">#&gt; 1 Berkshire        1   POINT (-115225 6697025)</span></span>
<span><span class="co">#&gt; 2 Berkshire        2 POINT (-103834.4 6696787)</span></span>
<span><span class="co">#&gt; 3 Berkshire        3 POINT (-118163.9 6700039)</span></span>
<span><span class="co">#&gt; 4 Berkshire        4 POINT (-108418.9 6693287)</span></span>
<span><span class="co">#&gt; 5 Berkshire        5 POINT (-114045.3 6700186)</span></span>
<span><span class="co">#&gt;  [ reached 'max' / getOption("max.print") -- omitted 5 rows ]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="types-of-featurecollection-results">Types of FeatureCollection results<a class="anchor" aria-label="anchor" href="#types-of-featurecollection-results"></a>
</h2>
<p>The FeatureCollection pbf can return three different types of results. They can be query results as above, or they can also be <strong>count</strong> or <strong>Object ID</strong> results.</p>
<p>Counts will always return a scalar integer vector.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/read_pbf.html">read_pbf</a></span><span class="op">(</span><span class="st">"inst/pbfs/count.pbf"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3143</span></span></code></pre></div>
<p>Whereas the Object ID result type will return a <code>data.frame</code> with a single column. The column name is the name of the object ID field and the values are the object IDs as a numeric vector.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_pbf.html">read_pbf</a></span><span class="op">(</span><span class="st">"inst/pbfs/ids.pbf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span></span>
<span><span class="co">#&gt;   OBJECTID</span></span>
<span><span class="co">#&gt; 1       93</span></span>
<span><span class="co">#&gt; 2       73</span></span>
<span><span class="co">#&gt; 3       83</span></span>
<span><span class="co">#&gt; 4       86</span></span>
<span><span class="co">#&gt; 5     2671</span></span>
<span><span class="co">#&gt; 6     3140</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="reading-from-a-raw-vector">Reading from a raw vector<a class="anchor" aria-label="anchor" href="#reading-from-a-raw-vector"></a>
</h2>
<p>The <code><a href="reference/open_pbf.html">open_pbf()</a></code> function will read a pbf file into a raw vector which can be passed to <code><a href="reference/process_pbf.html">process_pbf()</a></code>. In general you will not need this function, but it is handy for the sake of example.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbf_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/open_pbf.html">open_pbf</a></span><span class="op">(</span><span class="st">"inst/pbfs/big-pnts.pbf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pbf_raw</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 12 aa ec 10 0a a6 ec 10 0a 08 4f 62 6a 65 63 74 49 64 12 0c</span></span></code></pre></div>
<p>This raw vector can be turned into an R object using <code><a href="reference/process_pbf.html">process_pbf()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/process_pbf.html">process_pbf</a></span><span class="op">(</span><span class="va">pbf_raw</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">res</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ attributes:'data.frame':  1000 obs. of  18 variables:</span></span>
<span><span class="co">#&gt;  $ geometry  :sfc_POINT of length 1000; first list element:  'XY' num [1:2] -115225 6697025</span></span>
<span><span class="co">#&gt;  $ sr        :List of 5</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="processing-requests">Processing requests<a class="anchor" aria-label="anchor" href="#processing-requests"></a>
</h2>
<p>The true purpose of this package is to process requests from the REST API. Here we process a single request using <a href="https://httr2.r-lib.org/" class="external-link"><code>{httr2}</code></a></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/ACS_Population_by_Race_and_Hispanic_Origin_Boundaries/FeatureServer/2/query?where=1=1&amp;outFields=objectid&amp;f=pbf&amp;token="</span></span>
<span></span>
<span><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/request.html" class="external-link">request</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html" class="external-link">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html" class="external-link">resp_body_raw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/process_pbf.html">process_pbf</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span></span></code></pre></div>
<p>In developing an R package, one may be creating multiple requests in parallel using <code><a href="https://httr2.r-lib.org/reference/multi_req_perform.html" class="external-link">httr2::multi_req_perform()</a></code> as is done in <a href="https://github.com/R-ArcGIS/arcgislayers" class="external-link"><code>{arcgislayers}</code></a>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reqs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/request.html" class="external-link">request</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">resps</span> <span class="op">&lt;-</span> <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/multi_req_perform.html" class="external-link">multi_req_perform</a></span><span class="op">(</span><span class="va">reqs</span><span class="op">)</span></span></code></pre></div>
<p>We can process all of the responses using <code>multi_resp_process()</code> and pass the results to <code><a href="reference/post_process_pbf.html">post_process_pbf()</a></code>.</p>
<p>Note that when post processing a list of responses, <code><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">data.table::rbindlist()</a></code> will be used to bind the results together. If data.table is not available, <code><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">dplyr::bind_rows()</a></code> will be used. If dplyr is not available, rows will be bound together using <code>do.call(rbind.data.frame, x)</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">multi_resp_process</span><span class="op">(</span><span class="va">resps</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="reference/post_process_pbf.html">post_process_pbf</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -17298700 ymin: 2216212 xmax: -17253470 ymax: 2261306</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / Pseudo-Mercator</span></span>
<span><span class="co">#&gt;   OBJECTID                       geometry</span></span>
<span><span class="co">#&gt; 1        1 POLYGON ((-17264972 2244291...</span></span>
<span><span class="co">#&gt; 2        2 POLYGON ((-17264972 2244291...</span></span>
<span><span class="co">#&gt; 3        3 POLYGON ((-17264587 2241560...</span></span>
<span><span class="co">#&gt; 4        4 POLYGON ((-17263053 2239296...</span></span>
<span><span class="co">#&gt; 5        5 POLYGON ((-17261894 2236947...</span></span>
<span><span class="co">#&gt; 6        6 POLYGON ((-17262143 2241010...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="benchmarking">Benchmarking<a class="anchor" aria-label="anchor" href="#benchmarking"></a>
</h2>
<p>Below is a bench mark that compares processing pbfs to the current approach of processing raw json in arcgislayers and arcgisutils. The below recreates the example from the README of arcgislayers.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jsn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">json_reqs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_Counties_Generalized_Boundaries/FeatureServer/0/query?outFields=%2A&amp;where=1%3D1&amp;outSR=%7B%22wkid%22%3A4326%7D&amp;returnGeometry=TRUE&amp;token=&amp;f=json&amp;resultOffset=0"</span>,</span>
<span>    <span class="st">"https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_Counties_Generalized_Boundaries/FeatureServer/0/query?outFields=%2A&amp;where=1%3D1&amp;outSR=%7B%22wkid%22%3A4326%7D&amp;returnGeometry=TRUE&amp;token=&amp;f=json&amp;resultOffset=2001"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">reqs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">json_reqs</span>, <span class="fu">httr2</span><span class="fu">::</span><span class="va"><a href="https://httr2.r-lib.org/reference/request.html" class="external-link">request</a></span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="va">resps</span> <span class="op">&lt;-</span> <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/multi_req_perform.html" class="external-link">multi_req_perform</a></span><span class="op">(</span><span class="va">reqs</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">arcgisutils</span><span class="fu">::</span><span class="fu">parse_esri_json</span><span class="op">(</span><span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html" class="external-link">resp_body_string</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind.data.frame</span>, <span class="va">resps</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># protobuff processing </span></span>
<span><span class="va">pbf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">pbf_reqs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_Counties_Generalized_Boundaries/FeatureServer/0/query?outFields=%2A&amp;where=1%3D1&amp;outSR=%7B%22wkid%22%3A4326%7D&amp;returnGeometry=TRUE&amp;token=&amp;f=pbf&amp;resultOffset=0"</span>,</span>
<span>    <span class="st">"https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_Counties_Generalized_Boundaries/FeatureServer/0/query?outFields=%2A&amp;where=1%3D1&amp;outSR=%7B%22wkid%22%3A4326%7D&amp;returnGeometry=TRUE&amp;token=&amp;f=pbf&amp;resultOffset=2001"</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">reqs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">pbf_reqs</span>, <span class="fu">httr2</span><span class="fu">::</span><span class="va"><a href="https://httr2.r-lib.org/reference/request.html" class="external-link">request</a></span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">httr2</span><span class="fu">::</span><span class="fu"><a href="https://httr2.r-lib.org/reference/multi_req_perform.html" class="external-link">multi_req_perform</a></span><span class="op">(</span><span class="va">reqs</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">multi_resp_process</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="reference/post_process_pbf.html">post_process_pbf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span></span>
<span>  <span class="fu">jsn</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">pbf</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  relative <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Some expressions had a GC in every iteration; so filtering is</span></span>
<span><span class="co">#&gt; disabled.</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 6</span></span>
<span><span class="co">#&gt;   expression   min median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 jsn()       4.25   3.88      1         4.22      Inf</span></span>
<span><span class="co">#&gt; 2 pbf()       1      1         3.84      1         NaN</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="internals">Internals<a class="anchor" aria-label="anchor" href="#internals"></a>
</h2>
<p>Internally, there is a rust crate <a href="./src/rust/esripbf"><code>esripbf</code></a> which is a a Rust library built with <a href="https://github.com/tokio-rs/prost" class="external-link"><code>prost</code></a> to handle the <a href="https://github.com/Esri/arcgis-pbf/tree/main/proto/FeatureCollection" class="external-link">FeatureCollection Protocol Buffer Specification</a>.</p>
</div>
<div class="section level2">
<h2 id="notes">Notes<a class="anchor" aria-label="anchor" href="#notes"></a>
</h2>
<p>Alternatively, it may make sense to write to a geoarrow array and convert to sfc using {wk}. These are just thoughts.</p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>Apache License (&gt;= 2)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing arcpbf</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Josiah Parry <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-9910-865X" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/JosiahParry/arcpbf/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/JosiahParry/arcpbf/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Josiah Parry.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
